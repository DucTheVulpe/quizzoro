package yandextr

import (
	"errors"
	"fmt"
	"io/ioutil"
	"net/http"
	"regexp"
	"strings"
)

var (
	ErrNoSID = errors.New("translate: no sid found")
)

var (
	reSID = regexp.MustCompile(`SID: *'([^']+)'`)
)

func ParseSID() (string, error) {
	req, err := http.NewRequest(http.MethodGet, urlMain, nil)
	if err != nil {
		return "", err
	}

	resp, err := http.DefaultClient.Do(req)
	if err != nil {
		return "", nil
	}
	defer resp.Body.Close()
	if resp.StatusCode != 200 {
		return "", fmt.Errorf("translate: response code is %d", resp.StatusCode)
	}

	data, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		return "", err
	}

	match := reSID.FindStringSubmatch(string(data))
	if len(match) != 2 {
		return "", ErrNoSID
	}

	group := strings.Split(match[1], ".")
	if len(group) != 3 {
		return "", ErrNoSID
	}

	group = []string{
		reverseString(group[0]),
		reverseString(group[1]),
		reverseString(group[2]),
	}
	return strings.Join(group, ".") + "-0-0", nil
}

func reverseString(s string) string {
	r := []rune(s)
	for i, j := 0, len(r)-1; i < len(r)/2; i, j = i+1, j-1 {
		r[i], r[j] = r[j], r[i]
	}
	return string(r)
}
